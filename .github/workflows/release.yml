name: Release Obsidian Plugin
on:
  push:
    branches:
      - main
      - "[0-9]+.[0-9]+.[0-9]+"
    paths:
      - "manifest.json"
      - "versions.json"
      - "package.json"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18.x"

      - name: Build main plugin
        run: |
          npm install
          npm run build

      - name: Get version from manifest
        id: version
        run: |
          version=$(cat manifest.json | grep -Po '"version": *"\K[^"]*')
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "Version: $version"

      - name: Create distribution package
        run: |
          # Create a temporary directory for packaging
          mkdir -p dist
          
          # Copy required files
          cp main.js manifest.json styles.css dist/
          
          # Create zip file for distribution
          cd dist
          zip -r ../obsidian-todos-api-${{ steps.version.outputs.version }}.zip .
          cd ..
          
          # Create tarball for distribution
          tar -czf obsidian-todos-api-${{ steps.version.outputs.version }}.tar.gz -C dist .
          
          # List created files
          ls -la *.zip *.tar.gz

      - name: Check if release exists
        id: check_release
        run: |
          response=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \\
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ steps.version.outputs.version }}")
          if echo "$response" | grep -q '"message": "Not Found"'; then
            echo "exists=false" >> $GITHUB_OUTPUT
          else
            echo "exists=true" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release
        id: create_release
        if: steps.check_release.outputs.exists == 'false'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.version }}
          release_name: Release ${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
          body: |
            Obsidian Todos API Plugin ${{ steps.version.outputs.version }}
            
            ## Installation
            
            ### Using Obsidian Community Plugins
            
            1. Open Obsidian Settings
            2. Go to Community Plugins
            3. Search for "Todos API"
            4. Install and enable
            
            ### Manual Installation
            
            1. Download the latest release
            2. Extract the contents to your vault's plugins folder: `.obsidian/plugins/obsidian-todos-api/`
            3. Reload Obsidian
            4. Enable the plugin in Settings > Community plugins
            
            ## Files included in this release:
            - `main.js` - Main plugin code
            - `manifest.json` - Plugin metadata
            - `styles.css` - Plugin styles
            
            ## Distribution files:
            - `obsidian-todos-api-${{ steps.version.outputs.version }}.zip` - ZIP archive for manual installation
            - `obsidian-todos-api-${{ steps.version.outputs.version }}.tar.gz` - Tarball for manual installation

      - name: Upload Release Assets
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./main.js
          asset_name: main.js
          asset_content_type: application/javascript

      - name: Upload Manifest
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./manifest.json
          asset_name: manifest.json
          asset_content_type: application/json

      - name: Upload Styles
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./styles.css
          asset_name: styles.css
          asset_content_type: text/css

      - name: Upload ZIP Archive
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./obsidian-todos-api-${{ steps.version.outputs.version }}.zip
          asset_name: obsidian-todos-api-${{ steps.version.outputs.version }}.zip
          asset_content_type: application/zip

      - name: Upload Tarball
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./obsidian-todos-api-${{ steps.version.outputs.version }}.tar.gz
          asset_name: obsidian-todos-api-${{ steps.version.outputs.version }}.tar.gz
          asset_content_type: application/gzip